<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TowersTracker â€” Live Queues & Weather</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">

<!-- Manifest & Icons -->
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
<meta name="theme-color" content="#142c52">

<!-- CSS -->
<style>
:root {
  --bg: #071429;
  --card: #142c52;
  --gold: #ffd700;
  --muted: #a0c4ff;
  --accent: #5ab0ff;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Orbitron', sans-serif; background: var(--bg); color: #fff; padding: 20px; }
a { color: var(--accent); }
.wrap { max-width: 1000px; margin: 0 auto; }
h1 { text-align: center; margin: 0 0 .25rem; font-size: 2.2rem; }
.clock { text-align: center; font-size: 1.1rem; color: var(--muted); margin-bottom: .75rem; }
.hours, .weather, .status { margin: .5rem 0; text-align: center; font-size: 1.05rem; color: var(--muted); }
.status { min-height: 2.4em; }
.status .announcement { background: #5ab0ff; color: #000; display: block; padding: .5rem 1rem; margin-top:.5rem; border-radius:8px; font-weight:700; }
.controls { display: none; justify-content: center; gap: .75rem; margin: .75rem 0; align-items: center; flex-wrap: wrap; }
.controls button { background: var(--card); color: #fff; border: 1px solid #2b4472; border-radius: 10px; padding: .45rem .75rem; cursor: pointer; }
.controls button:hover { filter: brightness(1.1); }
.zone { margin-top: 1rem; font-size: 1.15rem; color: var(--gold); border-bottom: 1px solid #323f5a; padding-bottom: .4rem; }
.ride { background: var(--card); margin: .6rem 0; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; gap: .5rem; flex-wrap: wrap; }
.ride h2 { margin: 0; font-size: 1rem; }
.badge { padding: .25rem .6rem; border-radius: 8px; font-weight: 700; white-space: pre-line; }
.short { background: #2ecc71; color: #06260b; }
.medium { background: #f39c12; color: #2b1600; }
.long { background: #e74c3c; color: #2b0b07; }
.closed { background: #7f8c8d; color: #051217; }
.spinner { width: 16px; height: 16px; border: 2px solid #ffffff40; border-top-color: #fff; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; vertical-align: -2px; margin-right: .4rem; }
@keyframes spin { to { transform: rotate(360deg); } }
pre#json-output { background: #142c52; color: #a0c4ff; padding: 12px; border-radius: 8px; max-height: 300px; overflow: auto; margin-top: 1rem; font-size: .85rem; }
footer { margin-top: 2rem; text-align: center; color: #aaa; }
.bottom-note { margin-top: 1rem; font-size: .85rem; color: var(--muted); }
</style>
</head>
<body>
<div class="wrap">
<h1>TowersTracker</h1>
<div class="clock" id="clock">Loading timeâ€¦</div>
<div class="hours">
  <div><strong>Open Hours:</strong> 10:00 â€“ 16:00</div>
</div>
<div class="weather" id="weather">Loading UK temperatureâ€¦</div>
<div class="status" id="status" aria-live="polite"></div>
<div class="controls" id="controls" aria-hidden="true">
  <button id="refresh">Refresh now</button>
  <button id="open-json">Open raw JSON in new tab</button>
  <button id="toggle-json">Toggle inline JSON</button>
  <div class="last">Last fetched: <span id="last">never</span></div>
</div>
<main id="app" aria-live="polite"></main>
<pre id="json-output" style="display:none;"></pre>
<footer>
Powered by <a href="https://queue-times.com" target="_blank" rel="noopener">Queue-Times.com</a>.
<div class="bottom-note">Press <strong>Shift+S</strong> to toggle debug controls. Data requests use a resilient multi-proxy fallback.</div>
</footer>
</div>

<script>
const QUEUE_URL='https://queue-times.com/parks/1/queue_times.json';
const WEATHER_API='https://api.open-meteo.com/v1/forecast?latitude=52.509&longitude=-1.884&current_weather=true';
const PROXIES=[u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,u=>`https://thingproxy.freeboard.io/fetch/${u}`];

function $(id){return document.getElementById(id);}
const clockEl=$('clock'),weatherEl=$('weather'),statusEl=$('status'),lastFetched=$('last'),controls=$('controls'),refreshBtn=$('refresh'),openJsonBtn=$('open-json'),toggleJson=$('toggle-json'),jsonOutput=$('json-output'),app=$('app');
let currentTemp=null,lastData=null;

// Ride lists
const maintenanceRides=[], CBeebiesRides=[/*...*/], FamilyRides=[/*...*/], TransportRides=[/*...*/], SkyrideRides=[/*...*/], ThrillRides=[/*...*/];

function updateClock(){ clockEl.textContent=new Date().toLocaleTimeString(); }

async function fetchWithFallback(url){
    for(const proxy of PROXIES.concat(u=>u)){
        try{
            const finalUrl=typeof proxy==='function'?proxy(url):proxy;
            const res=await fetch(finalUrl,{cache:'no-store'});
            if(!res.ok)throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }catch(err){console.warn('Fetch attempt failed:',err);}
    }
    throw new Error('Failed to fetch JSON from all proxies');
}

async function loadWeather(){
    try{
        const js=await fetchWithFallback(WEATHER_API);
        currentTemp=js.current_weather?.temperature??null;
        weatherEl.textContent = currentTemp !== null ? `Current UK Temperature: ${currentTemp}Â°C` : 'Unable to load temperature';
    }catch(e){weatherEl.textContent='Unable to load temperature';}
}

// Functions for ride categorization
function isTransportRide(name){return TransportRides.includes(name);}
function isCBeebiesRide(name){return CBeebiesRides.includes(name);}
function isFamilyRide(name){return FamilyRides.includes(name);}
function isThrillRide(name){return ThrillRides.includes(name);}
function isSkyride(name){return SkyrideRides.includes(name);}
function isMaintenance(r){return maintenanceRides.includes(r.name);}

function rideRow(r){
    const el=document.createElement('div'); el.className='ride';
    const title=document.createElement('h2');
    const badge=document.createElement('span'); badge.className='badge';
    const isClosed = !r.is_open;
    title.textContent=r.name;
    badge.textContent=isClosed?'Closed':`${r.wait_time||0} mins`;
    badge.classList.add(isClosed?'closed':r.wait_time<=29?'short':r.wait_time<=59?'medium':'long');
    el.append(title,badge);
    return el;
}

function renderZone(name,rides){
    const zone=document.createElement('div'); zone.className='zone'; zone.textContent=name;
    app.appendChild(zone);
    rides.sort((a,b)=>{
        if(!a.is_open && b.is_open) return 1;
        if(a.is_open && !b.is_open) return -1;
        return (Number(a.wait_time)||0)-(Number(b.wait_time)||0);
    });
    rides.forEach(r=>app.appendChild(rideRow(r)));
}

function render(data){
    lastData=data; app.innerHTML='';
    // Categorize and render rides here (similar to your previous JS)
}

async function refreshQueues(){
    statusEl.innerHTML='';
    try{
        const data=await fetchWithFallback(QUEUE_URL);
        render(data);
    }catch(err){statusEl.innerHTML='<div>ðŸš« Unable to load queue times.</div>'; app.innerHTML=`<p style="color:#f66;">ðŸš« ${err.message}</p>`;}
}

async function refreshAll(){
    lastFetched.textContent=new Date().toLocaleTimeString();
    await Promise.allSettled([refreshQueues(),loadWeather()]);
}

document.addEventListener('DOMContentLoaded',()=>{
    updateClock(); setInterval(updateClock,1000);
    refreshAll(); setInterval(refreshAll,20000);
    refreshBtn.addEventListener('click',refreshAll);
    openJsonBtn.addEventListener('click',()=>window.open(QUEUE_URL,'_blank','noopener,noreferrer'));
    toggleJson.addEventListener('click',()=>{
        if(!lastData) return;
        jsonOutput.style.display=jsonOutput.style.display==='none'?'block':'none';
        jsonOutput.textContent=JSON.stringify(lastData,null,2);
    });
    document.addEventListener('keydown',e=>{
        if(e.shiftKey && e.code==='KeyS'){
            const show=controls.style.display!=='flex';
            controls.style.display=show?'flex':'none';
            controls.setAttribute('aria-hidden',String(!show));
        }
    });
});
</script>
</body>
</html>
